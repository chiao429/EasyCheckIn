# EasyCheck 系統架構

## 大人版系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         使用者層                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   參加者     │  │   管理員     │  │  工作人員    │          │
│  │  (手機/電腦) │  │  (電腦/平板) │  │  (平板/手機) │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                  │                  │                   │
│         │ 掃描 QR Code    │ 訪問管理後台    │ 協助簽到         │
│         │                  │                  │                   │
└─────────┼──────────────────┼──────────────────┼───────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      前端應用層 (Next.js)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │   首頁         │  │  簽到頁面      │  │  管理後台      │    │
│  │  (QR 產生器)   │  │  /checkin/[id] │  │  /admin/[id]   │    │
│  │  /             │  │                │  │                │    │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
│                                                                   │
│  功能：                                                           │
│  • QR Code 產生與下載                                            │
│  • 簽到表單與驗證                                                │
│  • 管理後台認證                                                  │
│  • 即時統計顯示                                                  │
│  • CSV 匯出                                                      │
│                                                                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ HTTP/HTTPS
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 層 (Next.js API Routes)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ POST         │  │ GET          │  │ GET          │          │
│  │ /api/checkin │  │ /api/        │  │ /api/search  │          │
│  │              │  │ attendees    │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                   │
│  功能：                                                           │
│  • 簽到邏輯處理                                                  │
│  • 資料驗證                                                      │
│  • 錯誤處理                                                      │
│  • 回應格式化                                                    │
│                                                                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ Google Sheets API
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    資料存取層 (lib/google-sheets.ts)             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  函式：                                                           │
│  • getGoogleSheetsClient()  - 建立 API 客戶端                   │
│  • getAllAttendees()        - 取得所有參加者                    │
│  • checkIn()                - 執行簽到                           │
│  • searchAttendee()         - 搜尋參加者                         │
│  • initializeSheet()        - 初始化工作表                       │
│                                                                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ Google Sheets API v4
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      資料儲存層 (Google Sheets)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  工作表結構：                                                     │
│  ┌──────┬──────┬────────────┬──────┐                           │
│  │ 序號 │ 姓名 │ 到達時間   │ 已到 │                           │
│  ├──────┼──────┼────────────┼──────┤                           │
│  │ 001  │ 王明 │ 2024/11/28 │ TRUE │                           │
│  │ 002  │ 李華 │            │      │                           │
│  │ 003  │ 張美 │ 2024/11/28 │ TRUE │                           │
│  └──────┴──────┴────────────┴──────┘                           │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

## 兒童版系統架構

兒童版（Kids）功能是一組與大人版平行的路由與 API，主要服務兒童活動的報到與管理。

### 兒童版系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         使用者層                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   家長/兒童  │  │   兒童事工同工│ │  兒童總召    │          │
│  │  (手機/電腦) │  │  (平板/手機)  │ │  (電腦/平板) │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                  │                  │                   │
│         │ 掃描 QR Code    │ 協助兒童報到    │ 查看總覽儀表板   │
│         │                  │                  │                   │
└─────────┼──────────────────┼──────────────────┼───────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    前端應用層 (Next.js, Kids)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │  兒童簽到頁面  │  │  兒童管理後台  │  │  兒童儀表板    │    │
│  │  /kids-check/  │  │  /kids-admin/  │  │  /kids-dashboard/ │  │
│  │  [eventId]     │  │  [eventId]     │  │  [eventId]        │  │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
│                                                                   │
│  其他輔助頁面：                                                   │
│  • /kids/                    兒童版入口/導覽                     │
│  • /kids-manager/[eventId]  兒童出席名單與狀態管理               │
│                                                                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ HTTP/HTTPS
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│               API 層 (Next.js API Routes, /api/kids/*)          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────┐  ┌──────────────────────────┐        │
│  │ GET /api/kids/attendees │  │ POST /api/kids/manager/* │      │
│  │ GET /api/kids/search  │  │ 取消報到 / 標記不會出席 / 已聯繫 │ │
│  └──────────────────────┘  └──────────────────────────┘        │
│                                                                   │
│  功能：                                                           │
│  • 讀取兒童出席名單                                              │
│  • 兒童報到狀態查詢與搜尋                                        │
│  • 更新兒童出席狀態（取消報到、不會出席）                        │
│  • 管理聯繫狀態（已聯繫 / 待聯繫）                               │
│                                                                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ Google Sheets API
                          │（與大人版共用或專屬兒童工作表）        
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    資料儲存層 (Google Sheets)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  工作表結構（兒童版）：                                           │
│  ┌──────┬──────┬────────────┬────────┬──────────┐              │
│  │ 序號 │ 姓名 │ 到達時間   │ 已到   │ 需要聯繫 │              │
│  ├──────┼──────┼────────────┼────────┼──────────┤              │
│  │ 001  │ 小明 │ 2024/...   │ TRUE   │          │              │
│  │ 002  │ 小華 │            │        │ TRUE     │              │
│  └──────┴──────┴────────────┴────────┴──────────┘              │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

## 資料流程圖

### 簽到流程

```
參加者
  │
  │ 1. 掃描 QR Code
  ▼
簽到頁面 (/checkin/[eventId])
  │
  │ 2. 輸入序號/姓名
  ▼
前端驗證
  │
  │ 3. POST /api/checkin
  │    { identifier, sheetId }
  ▼
API Route (checkin/route.ts)
  │
  │ 4. 呼叫 checkIn()
  ▼
Google Sheets 存取層
  │
  ├─ 5a. 查詢參加者資料
  │      GET spreadsheets.values
  │
  ├─ 5b. 驗證資料
  │      • 檢查序號/姓名是否存在
  │      • 檢查是否已簽到
  │
  └─ 5c. 更新簽到狀態
         UPDATE spreadsheets.values
         • 寫入到達時間
         • 設定已到 = TRUE
  │
  ▼
Google Sheets
  │
  │ 6. 回傳結果
  ▼
API Route
  │
  │ 7. 格式化回應
  │    { success, message, data }
  ▼
前端頁面
  │
  │ 8. 顯示結果
  ▼
參加者看到成功/失敗訊息
```

### 管理查詢流程

```
管理員
  │
  │ 1. 訪問管理後台
  ▼
管理後台 (/admin/[eventId])
  │
  │ 2. 輸入密碼
  ▼
前端密碼驗證
  │
  │ 3. GET /api/attendees?filter=all
  ▼
API Route (attendees/route.ts)
  │
  │ 4. 呼叫 getAllAttendees()
  ▼
Google Sheets 存取層
  │
  │ 5. 讀取所有資料
  │    GET spreadsheets.values
  ▼
Google Sheets
  │
  │ 6. 回傳資料陣列
  ▼
API Route
  │
  │ 7. 根據 filter 篩選
  │    • all: 全部
  │    • checked: 已到 = TRUE
  │    • unchecked: 已到 ≠ TRUE
  ▼
前端頁面
  │
  │ 8. 計算統計數字
  │    • 總人數
  │    • 已簽到
  │    • 未簽到
  │
  │ 9. 渲染表格
  ▼
管理員看到統計和名單
```

## 元件架構

```
app/
├── layout.tsx                    # 根佈局
│   └── 全域樣式、字體、metadata
│
├── page.tsx                      # 首頁
│   ├── QR Code 產生表單
│   ├── QR Code 顯示
│   ├── 使用說明
│   └── 功能特色
│
├── checkin/[eventId]/
│   └── page.tsx                  # 簽到頁面
│       ├── 輸入表單
│       ├── 簽到按鈕
│       └── 結果顯示
│
├── admin/[eventId]/
│   └── page.tsx                  # 管理後台
│       ├── 登入表單
│       ├── 統計卡片
│       ├── 分頁切換
│       ├── 搜尋功能
│       └── 資料表格
│
└── api/
    ├── checkin/route.ts          # 簽到 API
    ├── attendees/route.ts        # 查詢 API
    └── search/route.ts           # 搜尋 API

components/ui/
├── button.tsx                    # 按鈕元件
├── input.tsx                     # 輸入框元件
└── card.tsx                      # 卡片元件

lib/
├── google-sheets.ts              # Google Sheets 整合
└── utils.ts                      # 工具函式
```

## 認證流程

### 管理後台認證

```
使用者
  │
  │ 1. 訪問 /admin/[eventId]
  ▼
前端頁面
  │
  │ 2. 檢查 authenticated 狀態
  │    (useState)
  │
  ├─ 未認證 → 顯示登入表單
  │   │
  │   │ 3. 輸入密碼
  │   ▼
  │   比對密碼
  │   (process.env.NEXT_PUBLIC_ADMIN_PASSWORD)
  │   │
  │   ├─ 正確 → setAuthenticated(true)
  │   │          載入管理介面
  │   │
  │   └─ 錯誤 → 顯示錯誤訊息
  │
  └─ 已認證 → 顯示管理介面
```

### Google Sheets 認證

```
API Route
  │
  │ 1. 需要存取 Google Sheets
  ▼
getGoogleSheetsClient()
  │
  │ 2. 建立 GoogleAuth 物件
  │    credentials: {
  │      client_email: 服務帳號 email
  │      private_key: 私鑰
  │    }
  │
  │ 3. 設定 scopes
  │    ['https://www.googleapis.com/auth/spreadsheets']
  ▼
Google Sheets API Client
  │
  │ 4. 執行 API 操作
  │    • spreadsheets.values.get
  │    • spreadsheets.values.update
  ▼
Google Sheets
```

## 部署架構

```
開發環境 (本機)
  │
  │ git push
  ▼
GitHub Repository
  │
  │ Webhook 觸發
  ▼
Vercel CI/CD
  │
  ├─ 1. 拉取程式碼
  ├─ 2. 安裝依賴 (npm install)
  ├─ 3. 建置專案 (npm run build)
  ├─ 4. 注入環境變數
  └─ 5. 部署到 Edge Network
  │
  ▼
Vercel Edge Network (全球 CDN)
  │
  ├─ 亞洲節點
  ├─ 歐洲節點
  ├─ 美洲節點
  └─ 其他節點
  │
  ▼
使用者訪問
```

## 環境變數流程

```
開發環境
  │
  │ .env 檔案
  │ (不提交到 Git)
  │
  ▼
本機開發伺服器
  │
  │ process.env.*
  │
  └─ 伺服器端變數
      • GOOGLE_CLIENT_EMAIL
      • GOOGLE_PRIVATE_KEY
      • GOOGLE_SHEET_ID
      • ADMIN_PASSWORD
  
  └─ 客戶端變數
      • NEXT_PUBLIC_BASE_URL
      • NEXT_PUBLIC_SHEET_ID
      • NEXT_PUBLIC_ADMIN_PASSWORD

生產環境
  │
  │ Vercel Environment Variables
  │ (在 Vercel Dashboard 設定)
  │
  ▼
Vercel 建置過程
  │
  │ 注入環境變數
  │
  └─ 伺服器端變數 (不暴露給客戶端)
  └─ 客戶端變數 (打包進 JavaScript)
  │
  ▼
部署後的應用程式
```

## 錯誤處理流程

```
使用者操作
  │
  ▼
前端驗證
  │
  ├─ 通過 → 發送 API 請求
  │
  └─ 失敗 → 顯示前端錯誤訊息
  │
  ▼
API Route
  │
  │ try-catch 包裹
  │
  ├─ 成功
  │   │
  │   ▼
  │   Google Sheets 操作
  │   │
  │   ├─ 成功 → 回傳 { success: true, ... }
  │   │
  │   └─ 失敗 → throw Error
  │
  └─ 捕獲錯誤
      │
      │ console.error()
      │
      └─ 回傳 { success: false, message: '...' }
  │
  ▼
前端接收回應
  │
  ├─ success: true → 顯示成功訊息
  │
  └─ success: false → 顯示錯誤訊息
  │
  ▼
使用者看到結果
```

## 效能優化策略

### 前端優化

```
1. 程式碼分割
   • Next.js 自動分割
   • 動態 import
   • 路由層級分割

2. 資源優化
   • 圖片優化 (next/image)
   • 字體優化 (next/font)
   • CSS 最小化

3. 快取策略
   • 瀏覽器快取
   • CDN 快取
   • API 回應快取 (可選)

4. 載入優化
   • 懶載入
   • 預載入關鍵資源
   • 骨架屏 (可選)
```

### 後端優化

```
1. API 優化
   • 減少 Google Sheets API 呼叫
   • 批次處理請求
   • 錯誤重試機制

2. 資料優化
   • 只讀取必要欄位
   • 分頁載入 (可選)
   • 資料壓縮

3. 部署優化
   • Edge Functions
   • 全球 CDN
   • 自動擴展
```

## 監控與日誌

```
應用程式
  │
  ├─ 前端錯誤
  │   └─ console.error()
  │      └─ 瀏覽器開發者工具
  │
  ├─ API 錯誤
  │   └─ console.error()
  │      └─ Vercel 日誌
  │
  └─ Google Sheets API 錯誤
      └─ try-catch
         └─ Vercel 日誌

Vercel Dashboard
  │
  ├─ 部署日誌
  ├─ 函式日誌
  ├─ 效能監控
  └─ 錯誤追蹤

Google Cloud Console
  │
  ├─ API 使用量
  ├─ 配額監控
  └─ 錯誤日誌
```

## 擴展性設計

### 水平擴展

```
目前架構
  │
  └─ Vercel Serverless Functions
      • 自動擴展
      • 無需手動配置
      • 按需付費

未來擴展
  │
  ├─ 增加 Redis 快取層
  │   • 減少 Google Sheets API 呼叫
  │   • 提升回應速度
  │
  ├─ 改用專業資料庫
  │   • PostgreSQL
  │   • MongoDB
  │   • Firebase
  │
  └─ 實作佇列系統
      • 處理大量並發簽到
      • 確保資料一致性
```

### 功能擴展

```
目前功能
  │
  ├─ 基本簽到
  ├─ 管理後台
  └─ QR Code 產生

未來功能
  │
  ├─ 進階認證 (JWT)
  ├─ 多角色管理
  ├─ 即時推播
  ├─ 簽到照片
  ├─ 統計圖表
  ├─ 匯出多種格式
  └─ 行動 App
```

## 總結

EasyCheck 採用現代化的 Jamstack 架構，結合 Next.js、Google Sheets API 和 Vercel，提供：

- ✅ **簡單易用** - 單一 QR Code，無需複雜設定
- ✅ **快速部署** - 5 分鐘即可上線
- ✅ **成本低廉** - 完全免費（免費額度內）
- ✅ **效能優異** - 全球 CDN，快速回應
- ✅ **易於維護** - 清晰的架構，完整的文件
- ✅ **可擴展性** - 模組化設計，易於擴展

適合中小型活動的快速簽到需求！

---

**專案**: EasyCheck - 活動點名系統  
**版本**: 1.0.0  
**授權**: MIT License  
**建立日期**: 2024/11/28
